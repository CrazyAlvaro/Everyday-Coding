machine:
  environment:
    NODE_ENV: test
  services:
    - docker
  node:
    version: 5.11.1

database:
  override:
    - sudo /etc/init.d/postgresql stop
    - >
      docker run -d --name postgres
      -e POSTGRES_PASSWORD=
      -e POSTGRES_USER=ubuntu
      -e POSTGRES_DB=circle_test
      -p "5432:5432"
      postgres
    - sleep 10
    # migrate the database using test config
    - npm run db:migrate -- --env test
    - npm run db:installDefaults

test:
  pre:
    # start the postgrest service
    - >
      docker run -d --name postgrest
      --add-host db:$(ip addr show docker0 | grep "inet\b" | awk '{print $2}' | cut -d/ -f1)
      -e POSTGREST_ANONYMOUS=ubuntu
      -e PG_ENV_POSTGRES_USER=ubuntu
      -e PG_PORT_5432_TCP_ADDR=db
      -e PG_PORT_5432_TCP_PORT=5432
      -e PG_ENV_POSTGRES_DB=circle_test
      -p "3001:3000"
      begriffs/postgrest
  override:
    - npm run coverage
